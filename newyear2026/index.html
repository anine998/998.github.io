<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LUCKY 2026</title>

  <!-- Pixel font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+SC:wght@400;600;800&family=Noto+Sans+JP:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --red1:#ff2b2b;
      --red2:#c90a1a;
      --red3:#8a0713;
      --paper:#fff6f6;
      --ink:#2b0b10;

      --gold:#ffd27a;
      --gold2:#ffb84a;

      --cardRadius:26px;
      --panelRadius:18px;
      --stroke:rgba(255,255,255,.28);
      --shadow:0 22px 70px rgba(0,0,0,.30);
      --soft:0 10px 30px rgba(0,0,0,.18);

      --grid: repeating-linear-gradient(
        0deg,
        rgba(255,255,255,.06) 0,
        rgba(255,255,255,.06) 1px,
        transparent 1px,
        transparent 6px
      ),
      repeating-linear-gradient(
        90deg,
        rgba(255,255,255,.06) 0,
        rgba(255,255,255,.06) 1px,
        transparent 1px,
        transparent 6px
      );
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--paper);
      font-family: "Noto Sans SC","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:
        radial-gradient(900px 520px at 80% 15%, rgba(255,210,122,.18), transparent 55%),
        radial-gradient(900px 520px at 10% 0%, rgba(255,80,80,.20), transparent 55%),
        radial-gradient(1200px 800px at 40% 110%, rgba(0,0,0,.34), transparent 60%),
        linear-gradient(180deg, #120406, #0a0204 70%, #070103);
      overflow-x:hidden;
    }

    /* Falling fireworks / pixels */
    #fx{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      opacity:.95;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,.55));
    }

    .wrap{
      position:relative;
      z-index:2;
      width:min(1200px, 94vw);
      margin: clamp(14px, 3.2vw, 34px) auto;
      padding-bottom: 28px;
    }

    /* Big pixel red envelope card */
    .envelope{
      position:relative;
      border-radius: var(--cardRadius);
      background:
        linear-gradient(135deg, rgba(255,255,255,.10), transparent 42%),
        linear-gradient(315deg, rgba(0,0,0,.08), transparent 55%),
        linear-gradient(180deg, var(--red1), var(--red2) 58%, var(--red3));
      box-shadow: var(--shadow);
      border: 3px solid rgba(255,255,255,.22);
      overflow:hidden;
    }

    /* Pixel grid overlay */
    .envelope::before{
      content:"";
      position:absolute;
      inset:0;
      background: var(--grid);
      opacity:.22;
      mix-blend-mode: overlay;
      pointer-events:none;
    }

    /* Inner stroke */
    .envelope::after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius: calc(var(--cardRadius) - 10px);
      border: 1px solid rgba(255,255,255,.22);
      pointer-events:none;
    }

    .topBar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      padding: 18px 18px 6px 18px;
    }

    .badgeRow{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.28);
      background: rgba(0,0,0,.14);
      backdrop-filter: blur(8px);
      font-family: "Press Start 2P", system-ui;
      font-size: 11px;
      letter-spacing:.5px;
      text-transform: uppercase;
      white-space:nowrap;
    }

    .lang{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(0,0,0,.14);
      backdrop-filter: blur(10px);
    }
    .lang label{
      font-weight:800;
      font-size: 12px;
      opacity:.9;
    }
    .lang select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      padding: 8px 34px 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.24);
      background: rgba(255,255,255,.12);
      color: var(--paper);
      font-weight: 800;
      outline: none;
      cursor:pointer;
      position:relative;
    }
    .lang .caret{
      position:relative;
      margin-left:-28px;
      pointer-events:none;
      opacity:.9;
      font-weight:900;
    }

    .hero{
      display:grid;
      grid-template-columns: 1fr 280px;
      gap: 18px;
      padding: 10px 18px 14px 18px;
      align-items:center;
    }
    @media (max-width: 940px){
      .hero{ grid-template-columns: 1fr; }
    }

    .titleBox{
      padding: 16px 16px 10px 16px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.10);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }

    .titleBox::before{
      content:"";
      position:absolute;
      inset:-60px -40px auto -40px;
      height:120px;
      background: radial-gradient(circle at 50% 30%, rgba(255,210,122,.35), transparent 58%);
      filter: blur(2px);
      animation: shimmer 2.8s ease-in-out infinite;
      opacity:.85;
    }
    @keyframes shimmer{
      0%,100%{ transform: translateX(-10px); opacity:.75; }
      50%{ transform: translateX(14px); opacity:1; }
    }

    .bigTitle{
      display:flex;
      align-items:baseline;
      gap: 22px;
      flex-wrap:wrap;
      position:relative;
      z-index:2;
    }

    .bigTitle .luck,
    .bigTitle .y2026{
      font-family: "Press Start 2P", system-ui;
      color: var(--gold);
      text-shadow:
        0 6px 0 rgba(0,0,0,.18),
        0 0 22px rgba(255,210,122,.20);
      letter-spacing: 2px;
    }

    .bigTitle .luck{
      font-size: clamp(34px, 5vw, 62px);
      animation: pop 1.8s ease-in-out infinite;
      transform-origin: left center;
    }
    .bigTitle .y2026{
      font-size: clamp(38px, 5.8vw, 76px);
      animation: pop2 1.8s ease-in-out infinite;
      transform-origin: left center;
    }
    @keyframes pop{
      0%,100%{ transform: translateY(0) }
      50%{ transform: translateY(-4px) }
    }
    @keyframes pop2{
      0%,100%{ transform: translateY(0) }
      50%{ transform: translateY(-6px) }
    }

    .subtitle{
      margin-top: 10px;
      color: rgba(255,255,255,.92);
      font-weight: 700;
      line-height: 1.45;
      position:relative;
      z-index:2;
    }

    /* Cute pixel 财神 */
    .godBox{
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.10);
      backdrop-filter: blur(10px);
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 160px;
      position:relative;
      overflow:hidden;
    }
    .godBox::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(120px 90px at 60% 20%, rgba(255,210,122,.22), transparent 60%);
      opacity:.9;
    }
    .pixelGod{
      width: 112px;
      height: 112px;
      image-rendering: pixelated;
      transform: translateY(2px);
      animation: floaty 2.1s ease-in-out infinite;
      position:relative;
      z-index:2;
    }
    @keyframes floaty{
      0%,100%{ transform: translateY(2px) }
      50%{ transform: translateY(-6px) }
    }

    /* Make pixel art with CSS box-shadow */
    .pixelGod::before{
      content:"";
      position:absolute;
      left:0; top:0;
      width:8px; height:8px;
      background:transparent;
      box-shadow:
        /* hat */
        40px  0px #b90a1a, 48px  0px #b90a1a, 56px  0px #b90a1a, 64px  0px #b90a1a,
        32px  8px #b90a1a, 40px  8px #ff2b2b, 48px  8px #ff2b2b, 56px  8px #ff2b2b, 64px  8px #ff2b2b, 72px  8px #b90a1a,
        32px 16px #b90a1a, 40px 16px #ff2b2b, 48px 16px #ff2b2b, 56px 16px #ff2b2b, 64px 16px #ff2b2b, 72px 16px #b90a1a,
        48px 24px #ffd27a, 56px 24px #ffd27a,

        /* face */
        40px 32px #fff1e8, 48px 32px #fff1e8, 56px 32px #fff1e8, 64px 32px #fff1e8,
        40px 40px #fff1e8, 48px 40px #1b0b10, 56px 40px #fff1e8, 64px 40px #1b0b10, 72px 40px #fff1e8,
        32px 48px #fff1e8, 40px 48px #ff88a0, 48px 48px #fff1e8, 56px 48px #fff1e8, 64px 48px #ff88a0, 72px 48px #fff1e8,
        40px 56px #fff1e8, 48px 56px #fff1e8, 56px 56px #fff1e8, 64px 56px #fff1e8,

        /* body */
        32px 64px #b90a1a, 40px 64px #ff2b2b, 48px 64px #ff2b2b, 56px 64px #ff2b2b, 64px 64px #ff2b2b, 72px 64px #b90a1a,
        24px 72px #b90a1a, 32px 72px #ff2b2b, 40px 72px #ffd27a, 48px 72px #ff2b2b, 56px 72px #ff2b2b, 64px 72px #ffd27a, 72px 72px #ff2b2b, 80px 72px #b90a1a,

        /* sign */
        24px 80px #ffd27a, 32px 80px #ffd27a, 40px 80px #ffd27a, 48px 80px #ffd27a, 56px 80px #ffd27a, 64px 80px #ffd27a, 72px 80px #ffd27a, 80px 80px #ffd27a,
        24px 88px #ffd27a, 32px 88px #1b0b10, 40px 88px #1b0b10, 48px 88px #ffd27a, 56px 88px #1b0b10, 64px 88px #1b0b10, 72px 88px #ffd27a, 80px 88px #ffd27a,
        24px 96px #ffd27a, 32px 96px #ffd27a, 40px 96px #ffd27a, 48px 96px #ffd27a, 56px 96px #ffd27a, 64px 96px #ffd27a, 72px 96px #ffd27a, 80px 96px #ffd27a;
    }

    .content{
      padding: 0 18px 18px 18px;
    }

    .panel{
      background: rgba(255,255,255,.92);
      color: var(--ink);
      border-radius: 22px;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: var(--soft);
      padding: 14px;
      overflow:hidden;
    }

    .formRow{
      display:grid;
      grid-template-columns: 1fr 1fr auto auto;
      gap: 12px;
      align-items:end;
      margin-bottom: 10px;
    }
    @media (max-width: 860px){
      .formRow{ grid-template-columns: 1fr 1fr; }
      .btns{ grid-column: 1 / -1; justify-content:flex-end; }
    }

    .field label{
      display:block;
      font-weight:900;
      font-size: 13px;
      opacity:.86;
      margin: 2px 0 8px 2px;
    }
    input[type="date"], input[type="time"]{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.98);
      font-weight: 800;
      color: #2b0b10;
      outline:none;
    }

    .btns{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
    }
    button{
      border:0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      transition: transform .08s ease, filter .12s ease;
      user-select:none;
    }
    button:active{ transform: translateY(1px) scale(.99); }
    .primary{
      background: linear-gradient(180deg, #ffe0a8, #ffbe5a);
      color:#3c1602;
    }
    .ghost{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.12);
      color:#2b0b10;
    }

    .hint{
      font-size: 12px;
      opacity:.70;
      margin: 6px 2px 12px 2px;
      font-weight: 700;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .mini{
      border-radius: var(--panelRadius);
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.94);
      padding: 12px 12px;
      min-height: 96px;
    }
    .mini .k{
      font-weight: 1000;
      font-size: 13px;
      opacity:.76;
      margin-bottom: 8px;
    }
    .mini .v{
      font-weight: 1000;
      font-size: 22px;
      letter-spacing:.2px;
    }

    /* Lucky color chips */
    .chips{
      display:flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap:wrap;
    }
    .chip{
      width: 20px;
      height: 20px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 6px 14px rgba(0,0,0,.10);
    }

    /* Wealth direction big pixel text */
    .dirBig{
      font-family: "Press Start 2P", system-ui;
      font-weight: 900;
      letter-spacing: 2px;
      line-height: 1.05;
      margin-top: 10px;
      font-size: clamp(26px, 4.6vw, 62px);
      text-shadow: 0 3px 0 rgba(0,0,0,.10);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .dirSub{
      margin-top: 8px;
      font-size: 14px;
      font-weight: 1000;
      color: rgba(43,11,16,.72);
    }

    /* Five elements bars */
    .bars{
      margin-top: 6px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .barRow{
      display:grid;
      grid-template-columns: 28px 1fr 26px;
      gap: 10px;
      align-items:center;
    }
    .barRow .name{
      font-weight: 1000;
      opacity:.82;
    }
    .track{
      height: 14px;
      border-radius: 999px;
      background: rgba(0,0,0,.08);
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.10);
    }
    .fill{
      height:100%;
      width: 0%;
      border-radius: 999px;
      transition: width .35s ease;
    }
    .num{
      text-align:right;
      font-weight:1000;
      opacity:.78;
    }

    .footerNote{
      margin-top: 10px;
      font-size: 12px;
      opacity:.72;
      font-weight: 800;
    }

    /* Small sparkle on 财神 sign */
    .spark{
      position:absolute;
      right: 18px;
      top: 16px;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      background: rgba(255,210,122,.95);
      box-shadow: 0 0 18px rgba(255,210,122,.65);
      animation: tw 1.4s ease-in-out infinite;
      z-index:3;
    }
    @keyframes tw{
      0%,100%{ transform: rotate(0deg) scale(.9); opacity:.65; }
      50%{ transform: rotate(18deg) scale(1.25); opacity:1; }
    }

  </style>
</head>

<body>
  <canvas id="fx"></canvas>

  <div class="wrap">
    <div class="envelope">
      <div class="topBar">
        <div class="badgeRow">
          <div class="pill">2026</div>
          <div class="pill">PIXEL CARD</div>
        </div>

        <div class="lang">
          <label id="tLangLabel">语言</label>
          <select id="langSel">
            <option value="zh">中文</option>
            <option value="ja">日本語</option>
            <option value="en">English</option>
          </select>
          <span class="caret">▾</span>
        </div>
      </div>

      <div class="hero">
        <div class="titleBox">
          <div class="bigTitle">
            <!-- FIX #1: LUCK -> LUCKY -->
            <div class="luck" id="tLuck">LUCKY</div>
            <div class="y2026">2026</div>
          </div>
          <div class="subtitle" id="tSubtitle">
            像素新年贺卡：一键生成幸运色、幸运数字、金运方位与五行分布（娱乐用）。
          </div>
        </div>

        <div class="godBox" aria-label="pixel god of wealth">
          <div class="spark"></div>
          <div class="pixelGod" title="招财进宝"></div>
        </div>
      </div>

      <div class="content">
        <div class="panel">
          <div class="formRow">
            <div class="field">
              <label id="tDateLabel">出生日期</label>
              <input id="birthDate" type="date" />
            </div>

            <div class="field">
              <label id="tTimeLabel">出生时间</label>
              <input id="birthTime" type="time" value="09:00" />
            </div>

            <div class="btns">
              <button class="primary" id="btnGen">生成</button>
              <button class="ghost" id="btnMusic">音乐播放</button>
            </div>
          </div>

          <div class="hint" id="tHint">
            音乐需点击按钮播放（浏览器限制自动播放）。文件路径：haoyunlai.mp3
          </div>

          <div class="grid">
            <div class="mini">
              <div class="k" id="tLuckyColorK">幸运色</div>
              <div class="v" id="luckyColorV">—</div>
              <div class="chips" id="colorChips"></div>
            </div>

            <div class="mini">
              <div class="k" id="tLuckyNumK">幸运数字</div>
              <div class="v" id="luckyNumV">—</div>
            </div>

            <div class="mini">
              <div class="k" id="tDirK">金运方位</div>
              <div class="v dirBig" id="dirV">—</div>
              <div class="dirSub" id="dirSub">—</div>
            </div>

            <div class="mini">
              <div class="k" id="tFiveK">五行分布</div>
              <div class="bars" id="bars">
                <div class="barRow">
                  <div class="name" id="tWood">木</div>
                  <div class="track"><div class="fill" id="barWood"></div></div>
                  <div class="num" id="nWood">0</div>
                </div>
                <div class="barRow">
                  <div class="name" id="tFire">火</div>
                  <div class="track"><div class="fill" id="barFire"></div></div>
                  <div class="num" id="nFire">0</div>
                </div>
                <div class="barRow">
                  <div class="name" id="tEarth">土</div>
                  <div class="track"><div class="fill" id="barEarth"></div></div>
                  <div class="num" id="nEarth">0</div>
                </div>
                <div class="barRow">
                  <div class="name" id="tMetal">金</div>
                  <div class="track"><div class="fill" id="barMetal"></div></div>
                  <div class="num" id="nMetal">0</div>
                </div>
                <div class="barRow">
                  <div class="name" id="tWater">水</div>
                  <div class="track"><div class="fill" id="barWater"></div></div>
                  <div class="num" id="nWater">0</div>
                </div>
              </div>
            </div>
          </div>

          <div class="footerNote" id="tNote">注：娱乐用途，请勿用于现实决策。</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   i18n
========================= */
const I18N = {
  zh: {
    langLabel:"语言",
    subtitle:"像素新年贺卡：一键生成幸运色、幸运数字、金运方位与五行分布（娱乐用）。",
    date:"出生日期",
    time:"出生时间",
    gen:"生成",
    music:"好运之歌",
    hint:"音乐需点击按钮播放（浏览器限制自动播放）。文件路径：haoyunlai.mp3",
    luckyColor:"幸运色",
    luckyNum:"幸运数字",
    wealthDir:"金运方位",
    five:"五行分布",
    wood:"木", fire:"火", earth:"土", metal:"金", water:"水",
    note:"注：娱乐用途，请勿用于现实决策。",
    musicOn:"音乐已开始播放",
    musicOff:"音乐已暂停",
    musicFail:"音乐无法播放：请确认 haoyunlai.mp3 在 newyear2026 目录且可被直接打开。"
  },
  ja: {
    langLabel:"言語",
    subtitle:"ピクセル年賀カード：ラッキーカラー、ラッキーナンバー、金運方位、五行分布を生成（娯楽用途）。",
    date:"生年月日",
    time:"出生時間",
    gen:"生成",
    music:"開運ソング",
    hint:"音楽はボタンを押して再生（自動再生制限あり）。ファイル：haoyunlai.mp3",
    luckyColor:"ラッキーカラー",
    luckyNum:"ラッキーナンバー",
    wealthDir:"金運方位",
    five:"五行分布",
    wood:"木", fire:"火", earth:"土", metal:"金", water:"水",
    note:"注：娯楽目的です。現実の判断に使用しないでください。",
    musicOn:"音楽を再生しました",
    musicOff:"音楽を一時停止しました",
    musicFail:"再生できません：haoyunlai.mp3 が newyear2026 にあり、直接開けるか確認してください。"
  },
  en: {
    langLabel:"Language",
    subtitle:"Pixel New Year card: generate lucky colors, lucky numbers, wealth direction, and five-element distribution (for fun).",
    date:"Birth date",
    time:"Birth time",
    gen:"Generate",
    music:"Lucky Song",
    hint:"Music requires a click to play (browser policy). File: haoyunlai.mp3",
    luckyColor:"Lucky color",
    luckyNum:"Lucky numbers",
    wealthDir:"Wealth direction",
    five:"Five elements",
    wood:"Wood", fire:"Fire", earth:"Earth", metal:"Metal", water:"Water",
    note:"Note: for entertainment only. Do not use for real-world decisions.",
    musicOn:"Music is playing",
    musicOff:"Music paused",
    musicFail:"Cannot play: ensure haoyunlai.mp3 is in newyear2026 and opens directly."
  }
};

const el = (id)=>document.getElementById(id);

function applyLang(lang){
  const t = I18N[lang] || I18N.zh;
  el("tLangLabel").textContent = t.langLabel;
  el("tSubtitle").textContent = t.subtitle;
  el("tDateLabel").textContent = t.date;
  el("tTimeLabel").textContent = t.time;
  el("btnGen").textContent = t.gen;
  el("btnMusic").textContent = t.music;
  el("tHint").textContent = t.hint;

  el("tLuckyColorK").textContent = t.luckyColor;
  el("tLuckyNumK").textContent = t.luckyNum;
  el("tDirK").textContent = t.wealthDir;
  el("tFiveK").textContent = t.five;

  el("tWood").textContent = t.wood;
  el("tFire").textContent = t.fire;
  el("tEarth").textContent = t.earth;
  el("tMetal").textContent = t.metal;
  el("tWater").textContent = t.water;

  el("tNote").textContent = t.note;
}

/* =========================
   Deterministic RNG (FNV-1a + LCG)
========================= */
function hashSeed(str){
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return (h >>> 0);
}
function makeRng(seed){
  let s = seed >>> 0;
  return function(){
    s = (Math.imul(1664525, s) + 1013904223) >>> 0;
    return s / 4294967296;
  }
}

/* =========================
   Wealth direction (expanded)
========================= */
const DIR_POOL = [
  "东","西","南","北","东北","东南","西北","西南",
  "东偏北","东偏南","西偏北","西偏南",
  "南偏东","南偏西","北偏东","北偏西",
  "东南偏东","东南偏南","东北偏东","东北偏北",
  "西南偏西","西南偏南","西北偏西","西北偏北"
];

function dirToAbbr(dir){
  const m = {
    "东":"E","西":"W","南":"S","北":"N",
    "东北":"NE","东南":"SE","西北":"NW","西南":"SW",

    "东偏北":"ENE","东偏南":"ESE",
    "西偏北":"WNW","西偏南":"WSW",
    "南偏东":"SSE","南偏西":"SSW",
    "北偏东":"NNE","北偏西":"NNW",

    "东南偏东":"ESE","东南偏南":"SSE",
    "东北偏东":"ENE","东北偏北":"NNE",
    "西南偏西":"WSW","西南偏南":"SSW",
    "西北偏西":"WNW","西北偏北":"NNW"
  };
  return m[dir] || "—";
}

/* FIX #2: localized direction label */
function dirLabel(dirCN, lang){
  const abbr = dirToAbbr(dirCN);
  if(!abbr || abbr === "—") return "—";
  if(lang === "zh") return dirCN;

  if(lang === "ja"){
    const m = {
      N:"北", S:"南", E:"東", W:"西",
      NE:"北東", NW:"北西", SE:"南東", SW:"南西",
      NNE:"北北東", ENE:"東北東", ESE:"東南東", SSE:"南南東",
      SSW:"南南西", WSW:"西南西", WNW:"西北西", NNW:"北北西"
    };
    return m[abbr] || abbr;
  }

  if(lang === "en"){
    const m = {
      N:"North", S:"South", E:"East", W:"West",
      NE:"Northeast", NW:"Northwest", SE:"Southeast", SW:"Southwest",
      NNE:"North-northeast", ENE:"East-northeast", ESE:"East-southeast", SSE:"South-southeast",
      SSW:"South-southwest", WSW:"West-southwest", WNW:"West-northwest", NNW:"North-northwest"
    };
    return m[abbr] || abbr;
  }
  return dirCN;
}

/* Fit big direction text to its box */
function fitDirText(){
  const box = el("dirV");
  if(!box) return;
  // Reset to a generous size then shrink if overflow
  box.style.fontSize = "clamp(26px, 4.6vw, 62px)";
  // After paint, check overflow
  requestAnimationFrame(()=>{
    let fs = parseFloat(getComputedStyle(box).fontSize);
    const min = 24;
    while (box.scrollWidth > box.clientWidth && fs > min){
      fs -= 2;
      box.style.fontSize = fs + "px";
    }
  });
}

/* =========================
   Lucky colors / Five elements
========================= */
const ELEMENTS = ["wood","fire","earth","metal","water"];
const BAR_COLORS = {
  wood:"#2fb86a",
  fire:"#ff3b3b",
  earth:"#ffcc5a",
  metal:"#b8b8b8",
  water:"#2a7bff"
};

/* FIX #3: color objects include localized names */
const COLOR_PALETTES = {
  wood: [
    {nameZH:"青绿", nameJA:"青緑", nameEN:"Teal Green", hex:"#2fb86a"},
    {nameZH:"翠绿", nameJA:"翠緑", nameEN:"Emerald Green", hex:"#22c55e"},
    {nameZH:"墨绿", nameJA:"深緑", nameEN:"Deep Green", hex:"#0f766e"}
  ],
  fire: [
    {nameZH:"正红", nameJA:"レッド", nameEN:"Red", hex:"#ff2b2b"},
    {nameZH:"珊瑚", nameJA:"コーラル", nameEN:"Coral", hex:"#ff6b6b"},
    {nameZH:"橙红", nameJA:"オレンジレッド", nameEN:"Orange Red", hex:"#ff5a2a"}
  ],
  earth: [
    {nameZH:"金黄", nameJA:"ゴールドイエロー", nameEN:"Golden Yellow", hex:"#ffcc5a"},
    {nameZH:"琥珀", nameJA:"アンバー", nameEN:"Amber", hex:"#ffb84a"},
    {nameZH:"卡其", nameJA:"カーキ", nameEN:"Khaki", hex:"#c8a96a"}
  ],
  metal: [
    {nameZH:"银灰", nameJA:"シルバーグレー", nameEN:"Silver Gray", hex:"#c9c9c9"},
    {nameZH:"珍珠白", nameJA:"パールホワイト", nameEN:"Pearl White", hex:"#f2f2f2"},
    {nameZH:"香槟", nameJA:"シャンパン", nameEN:"Champagne", hex:"#e8d8b8"}
  ],
  water: [
    {nameZH:"深蓝", nameJA:"ネイビー", nameEN:"Deep Blue", hex:"#2a7bff"},
    {nameZH:"青蓝", nameJA:"ターコイズ", nameEN:"Turquoise", hex:"#2dd4bf"},
    {nameZH:"靛蓝", nameJA:"インディゴ", nameEN:"Indigo", hex:"#4f46e5"}
  ]
};

function genFive(rng){
  // Make 5 positive-ish numbers and normalize to total 10
  let raw = ELEMENTS.map(()=> rng()*1.0 + 0.15); // avoid all zero
  const sum = raw.reduce((a,b)=>a+b,0);
  let vals = raw.map(v => Math.round((v/sum)*10));
  // fix rounding to sum 10
  let diff = 10 - vals.reduce((a,b)=>a+b,0);
  while(diff !== 0){
    const i = Math.floor(rng()*5);
    if(diff > 0){ vals[i]++; diff--; }
    else if(diff < 0 && vals[i] > 0){ vals[i]--; diff++; }
  }
  const obj = {};
  ELEMENTS.forEach((k,i)=>obj[k]=vals[i]);
  return obj;
}

function dominantElement(five){
  let best = "earth", bestV = -1;
  for(const k of ELEMENTS){
    if(five[k] > bestV){ bestV = five[k]; best = k; }
  }
  return best;
}

function pickLuckyNumbers(rng){
  const arr = [];
  while(arr.length < 3){
    const n = 1 + Math.floor(rng()*9);
    if(!arr.includes(n)) arr.push(n);
  }
  return arr;
}

function pickOneColor(palette, rng){
  if(!palette || !palette.length) return null;
  return palette[Math.floor(rng() * palette.length)];
}

function getColorNameByLang(c, lang){
  if(!c) return "—";
  if(lang === "ja") return c.nameJA || c.nameZH || "—";
  if(lang === "en") return c.nameEN || c.nameZH || "—";
  return c.nameZH || "—";
}

/* =========================
   Music
========================= */
let audio;
let audioReady = false;
function initAudio(){
  // Use relative path, so it works under /998.github.io/newyear2026/
  audio = new Audio("./haoyunlai.mp3");
  audio.loop = true;
  audio.preload = "auto";
  audio.addEventListener("canplaythrough", ()=>{ audioReady = true; });
  audio.addEventListener("error", ()=>{ audioReady = false; });
}
initAudio();

function toast(msg){
  alert(msg);
}

/* =========================
   Bind UI
========================= */
function setBar(id, value, max, color){
  const pct = max <= 0 ? 0 : Math.round((value/max)*100);
  const bar = el(id);
  bar.style.background = color;
  bar.style.width = pct + "%";
}

function setChips(palette){
  const box = el("colorChips");
  box.innerHTML = "";
  palette.forEach(c=>{
    const d = document.createElement("div");
    d.className = "chip";
    d.style.background = c.hex;
    box.appendChild(d);
  });
}

function generate(){
  const lang = el("langSel").value || "zh";
  const d = el("birthDate").value;
  const t0 = el("birthTime").value || "09:00";

  if(!d){
    // Give a default if empty
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const dd = String(now.getDate()).padStart(2,"0");
    el("birthDate").value = `${yyyy}-${mm}-${dd}`;
  }

  const dateStr = el("birthDate").value;

  // FIX: seed should NOT depend on language (results stable across language switch)
  const seed = hashSeed(`LUCK2026|${dateStr}|${t0}`);
  const rng = makeRng(seed);

  // Five elements
  const five = genFive(rng);
  const maxV = Math.max(...ELEMENTS.map(k=>five[k]));

  setBar("barWood", five.wood, maxV, BAR_COLORS.wood);
  setBar("barFire", five.fire, maxV, BAR_COLORS.fire);
  setBar("barEarth", five.earth, maxV, BAR_COLORS.earth);
  setBar("barMetal", five.metal, maxV, BAR_COLORS.metal);
  setBar("barWater", five.water, maxV, BAR_COLORS.water);

  el("nWood").textContent = five.wood;
  el("nFire").textContent = five.fire;
  el("nEarth").textContent = five.earth;
  el("nMetal").textContent = five.metal;
  el("nWater").textContent = five.water;

  // Lucky colors: show a direct color name (localized) + chips palette
  const dom = dominantElement(five);
  const pal = COLOR_PALETTES[dom] || COLOR_PALETTES.earth;
  setChips(pal);

  const picked = pickOneColor(pal, rng);
  el("luckyColorV").textContent = getColorNameByLang(picked, lang);

  // Lucky numbers
  const nums = pickLuckyNumbers(rng);
  el("luckyNumV").textContent = nums.join("/");

  // Wealth direction (expanded) with localized sub-label
  const dirCN = DIR_POOL[Math.floor(rng()*DIR_POOL.length)];
  const abbr = dirToAbbr(dirCN);
  el("dirV").textContent = abbr;                 // big pixel
  el("dirSub").textContent = dirLabel(dirCN, lang); // localized

  fitDirText();
}

/* =========================
   Events
========================= */
el("btnGen").addEventListener("click", generate);

el("btnMusic").addEventListener("click", async ()=>{
  const lang = el("langSel").value || "zh";
  const t = I18N[lang] || I18N.zh;

  try{
    if(!audio){ initAudio(); }
    if(audio.paused){
      // ensure src is set (in case previous errors)
      audio.src = "./haoyunlai.mp3";
      await audio.play();
      toast(t.musicOn);
    }else{
      audio.pause();
      toast(t.musicOff);
    }
  }catch(e){
    toast(t.musicFail);
  }
});

el("langSel").addEventListener("change", ()=>{
  const v = el("langSel").value;
  localStorage.setItem("luck2026_lang", v);
  applyLang(v);

  // FIX: re-render in the selected language
  generate();
  fitDirText();
});

/* =========================
   Init state
========================= */
(function init(){
  const saved = localStorage.getItem("luck2026_lang") || "zh";
  el("langSel").value = saved;
  applyLang(saved);

  // default date: today
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,"0");
  const dd = String(now.getDate()).padStart(2,"0");
  el("birthDate").value = `${yyyy}-${mm}-${dd}`;

  // paint default bars (empty) nicely
  ["barWood","barFire","barEarth","barMetal","barWater"].forEach(id=>{
    el(id).style.background = "#ddd";
    el(id).style.width = "0%";
  });

  // generate once
  generate();
})();

/* =========================
   Pixel fireworks / falling particles
========================= */
const canvas = document.getElementById("fx");
const ctx = canvas.getContext("2d");

let W=0,H=0,particles=[];
function resize(){
  W = canvas.width = window.innerWidth * devicePixelRatio;
  H = canvas.height = window.innerHeight * devicePixelRatio;
  canvas.style.width = window.innerWidth + "px";
  canvas.style.height = window.innerHeight + "px";
}
window.addEventListener("resize", resize);
resize();

function rand(a,b){ return a + Math.random()*(b-a); }

function spawn(){
  // pixel squares falling like fireworks fragments
  const count = Math.random() < 0.45 ? 2 : 1;
  for(let i=0;i<count;i++){
    particles.push({
      x: rand(0,W),
      y: -10 * devicePixelRatio,
      s: (Math.random()<0.7? 2:3) * devicePixelRatio,
      vy: rand(1.2, 3.8) * devicePixelRatio,
      vx: rand(-0.25, 0.25) * devicePixelRatio,
      a: rand(0.6, 1.0),
      hue: Math.floor(rand(0,360)),
      life: rand(260,520)
    });
  }
}

function step(){
  ctx.clearRect(0,0,W,H);

  // spawn rate
  if(particles.length < 160){
    if(Math.random()<0.88) spawn();
  }

  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.life -= 1;

    // slight twinkle
    const tw = 0.6 + 0.4*Math.sin((p.life)*0.08);
    const alpha = Math.max(0, p.a * tw);

    ctx.globalAlpha = alpha;
    // favor red/gold/white
    const pick = Math.random();
    let col = "rgba(255,255,255,.9)";
    if(pick < 0.45) col = "rgba(255,210,122,.95)";
    else if(pick < 0.80) col = "rgba(255,80,80,.92)";

    ctx.fillStyle = col;
    ctx.fillRect(p.x, p.y, p.s, p.s);

    // remove
    if(p.y > H + 20*devicePixelRatio || p.life <= 0){
      particles.splice(i,1);
    }
  }

  ctx.globalAlpha = 1;
  requestAnimationFrame(step);
}
step();
</script>

</body>
</html>
